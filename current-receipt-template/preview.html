<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Receipt Template Preview</title>
    <link rel="stylesheet" href="css/print-preview.css">
    <!-- Export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }
        select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            font-weight: bold;
        }
        button:hover {
            background: #45a049;
        }
        .main-content {
            display: flex;
            min-height: calc(100vh - 120px);
        }
        .preview-container {
            display: flex;
            justify-content: center;
            padding: 20px;
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }
        .preview-container.panel-collapsed {
            margin-left: 0;
        }
        #preview-content {
            transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1);
            width: 100%;
        }
        #preview-content.fade-out {
            opacity: 0;
            transition: opacity 0.25s cubic-bezier(0.4, 0, 1, 1);
        }
        #preview-content.fade-in {
            opacity: 1;
            transition: opacity 0.3s cubic-bezier(0.42, 0, 1, 1);
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 4px;
            margin: 20px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <!-- Side Control Panel -->
        <div class="side-panel" id="side-panel">
            <div class="side-panel-header">
                <h1>Print Receipt Template Preview</h1>
                <button class="panel-toggle" id="panel-toggle" onclick="togglePanel()" aria-label="Toggle panel">
                    <span class="toggle-icon">‹</span>
                </button>
            </div>
            <div class="side-panel-content">
                <div class="control-section">
                    <label class="control-label">Export:</label>
                    <div class="export-buttons">
                        <button class="export-btn export-png" onclick="exportToPNG()">PNG</button>
                        <button class="export-btn export-pdf" onclick="exportToPDF()">PDF</button>
                    </div>
                </div>
                <div class="control-section">
                    <label class="control-label">Template Type:</label>
                    <select id="template-type-select" class="control-select">
                        <option value="bill">Bill</option>
                        <option value="transaction" selected>Transaction</option>
                        <option value="transaction_v2">Transaction V2</option>
                    </select>
                </div>
                <div class="control-section">
                    <label class="control-label">Payment Mode:</label>
                    <select id="payment-mode-select" class="control-select" onchange="changePaymentMode(this.value)">
                        <option value="Cash">Cash</option>
                        <option value="UPI" selected>UPI</option>
                        <option value="Due">Due</option>
                        <option value="Card">Card</option>
                    </select>
                </div>
                <div class="control-section">
                    <label class="control-label">Format:</label>
                    <div class="format-switcher">
                        <button class="format-btn" id="format-2inch" onclick="switchFormat('2inch')">2 inch</button>
                        <button class="format-btn active" id="format-3inch" onclick="switchFormat('3inch')">3 inch</button>
                    </div>
                </div>
                <div class="control-section">
                    <label class="control-label">Tax Type:</label>
                    <div class="format-switcher">
                        <button class="format-btn active" id="tax-cgst-sgst" onclick="switchTaxType('cgst-sgst')">CGST/SGST</button>
                        <button class="format-btn" id="tax-igst" onclick="switchTaxType('igst')">IGST</button>
                    </div>
                </div>
                <div class="control-section toggle-section">
                    <label class="control-label">Logo:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="logo-toggle" checked onchange="toggleLogo(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="control-section toggle-section">
                    <label class="control-label">Cashier:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="cashier-toggle" checked onchange="toggleCashier(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="control-section toggle-section" id="decimals-control" style="display: none;">
                    <label class="control-label">Show Decimals:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="decimals-toggle" checked onchange="toggleDecimals(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="control-section toggle-section">
                    <label class="control-label">GSTIN:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="gstin-toggle" checked onchange="toggleGSTIN(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="control-section">
                    <label class="control-label">Discount:</label>
                    <div class="format-switcher">
                        <button class="format-btn active" id="discount-percentage" onclick="toggleDiscountType(true)">%</button>
                        <button class="format-btn" id="discount-currency" onclick="toggleDiscountType(false)">₹</button>
                    </div>
                </div>
                <div class="control-section toggle-section" id="serial-no-control" style="display: none;">
                    <label class="control-label">Serial No:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="serial-no-toggle" checked onchange="toggleSerialNo(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="control-section toggle-section" id="total-qty-items-control" style="display: none;">
                    <label class="control-label">Total Qty/Items:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="total-qty-items-toggle" checked onchange="toggleTotalQtyItems(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="preview-container" id="preview-container">
            <div id="preview-content">
                <div class="loading">Loading preview...</div>
            </div>
        </div>
    </div>

    <script src="js/print-template-engine.js"></script>
    <script>
        // Track current template type and format
        let currentTemplateType = 'transaction'; // 'bill' or 'transaction'
        let currentFormat = '3inch'; // '2inch' or '3inch'
        let currentTaxType = 'cgst-sgst'; // 'cgst-sgst' or 'igst'
        let showLogo = true; // Show or hide logo placeholder
        let showCashier = true; // Show or hide cashier field
        let originalCashierValue = null; // Store original cashier value
        let showDecimals = true; // Show or hide decimal digits for Bill template
        let showGSTIN = true; // Show or hide GSTIN field and tax fields
        let showSerialNo = true; // Show or hide serial number column for Bill template
        let currentPaymentMode = 'UPI'; // Current payment mode (Cash, UPI, Due, Card)
        let discountAsPercentage = true; // Show discount as percentage (true) or currency (false) - default to percentage mode
        let showTotalQtyItems = true; // Show or hide total qty/items row for Bill and Transaction templates
        let isInitialLoad = true; // Track if this is the first load

        /**
         * Get template path based on current type and format
         */
        function getTemplatePath() {
            let type;
            if (currentTemplateType === 'bill') {
                type = 'bill';
            } else if (currentTemplateType === 'transaction_v2') {
                type = 'transaction_v2';
            } else {
                type = 'transaction';
            }
            const format = currentFormat === '2inch' ? '2inch' : '3inch';
            return `templates/print_${type}_${format}_template.json`;
        }

        /**
         * Toggle side panel visibility
         */
        function togglePanel() {
            const panel = document.getElementById('side-panel');
            const container = document.getElementById('preview-container');
            const toggleIcon = document.querySelector('.toggle-icon');
            
            panel.classList.toggle('collapsed');
            container.classList.toggle('panel-collapsed');
            toggleIcon.textContent = panel.classList.contains('collapsed') ? '›' : '‹';
        }

        /**
         * Switch format (2 inch / 3 inch)
         */
        function switchFormat(format) {
            if (format === currentFormat) return;
            
            currentFormat = format;
            
            // Update button states
            document.getElementById('format-2inch').classList.toggle('active', format === '2inch');
            document.getElementById('format-3inch').classList.toggle('active', format === '3inch');
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Switch tax type (CGST/SGST or IGST)
         */
        function switchTaxType(taxType) {
            if (taxType === currentTaxType) return;
            
            currentTaxType = taxType;
            
            // Update button states
            document.getElementById('tax-cgst-sgst').classList.toggle('active', taxType === 'cgst-sgst');
            document.getElementById('tax-igst').classList.toggle('active', taxType === 'igst');
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Toggle logo placeholder visibility
         */
        function toggleLogo(show) {
            if (show === showLogo) return;
            
            showLogo = show;
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Toggle cashier field visibility
         */
        function toggleCashier(show) {
            if (show === showCashier) return;
            
            showCashier = show;
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Toggle decimal digits visibility for Bill template
         */
        function toggleDecimals(show) {
            if (show === showDecimals) return;
            
            showDecimals = show;
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Toggle GSTIN field visibility
         * When GSTIN is hidden, tax fields (CGST/SGST/IGST) are also hidden
         */
        function toggleGSTIN(show) {
            if (show === showGSTIN) return;
            
            showGSTIN = show;
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Toggle discount display type (percentage or currency)
         */
        function toggleDiscountType(asPercentage) {
            if (asPercentage === discountAsPercentage) return;
            
            discountAsPercentage = asPercentage;
            
            // Update button states
            document.getElementById('discount-percentage').classList.toggle('active', asPercentage);
            document.getElementById('discount-currency').classList.toggle('active', !asPercentage);
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Toggle serial number column visibility for Bill template
         */
        function toggleSerialNo(show) {
            if (show === showSerialNo) return;
            
            showSerialNo = show;
            
            // Reload preview automatically
            loadPreview();
        }

        function toggleTotalQtyItems(show) {
            if (show === showTotalQtyItems) return;
            
            showTotalQtyItems = show;
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Change payment mode
         */
        function changePaymentMode(mode) {
            if (mode === currentPaymentMode) return;
            
            currentPaymentMode = mode;
            
            // Reload preview automatically
            loadPreview();
        }

        /**
         * Format currency with optional decimals
         */
        function formatCurrencyWithDecimals(value) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            if (showDecimals) {
                return '₹' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                return '₹' + Math.round(value).toLocaleString('en-IN');
            }
        }

        /**
         * Format number without currency symbol, with optional decimals
         */
        function formatNumberLimitedWithDecimals(value, maxLength) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            let formatted;
            if (showDecimals) {
                formatted = value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                formatted = Math.round(value).toLocaleString('en-IN');
            }
            // Truncate if exceeds max length
            if (formatted.length > maxLength) {
                return formatted.substring(0, maxLength);
            }
            return formatted;
        }

        async function loadPreview() {
            const previewContent = document.getElementById('preview-content');
            const selectedTemplate = getTemplatePath();
            
            // Fade out current content (skip on initial load)
            if (!isInitialLoad) {
                previewContent.classList.remove('fade-in');
                previewContent.classList.add('fade-out');
                
                // Wait for fade-out animation to complete
                await new Promise(resolve => setTimeout(resolve, 250));
            }
            
            previewContent.innerHTML = '<div class="loading">Loading preview...</div>';
            
            try {
                // Load template (with cache-busting to ensure fresh template)
                const templateUrl = selectedTemplate + '?t=' + Date.now() + '&_=' + Math.random();
                console.log('Loading template from:', templateUrl);
                const templateResponse = await fetch(templateUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!templateResponse.ok) {
                    throw new Error(`Failed to load template: ${templateResponse.statusText}`);
                }
                let template = await templateResponse.json();
                
                // Load sample data (with cache-busting to ensure fresh data)
                let sampleData;
                try {
                    const dataUrl = 'data/variables-example.json?t=' + Date.now() + '&_=' + Math.random();
                    console.log('Loading data from:', dataUrl);
                    const dataResponse = await fetch(dataUrl, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    if (dataResponse.ok) {
                        sampleData = await dataResponse.json();
                        console.log('Data loaded successfully:', sampleData);
                        // Store original cashier value on first load
                        if (originalCashierValue === null && sampleData.cashier && sampleData.cashier !== 'N/A') {
                            originalCashierValue = sampleData.cashier;
                        }
                    } else {
                        console.warn('Failed to load data, using default');
                        sampleData = PrintTemplateEngine.getDefaultSampleData();
                        if (originalCashierValue === null && sampleData.cashier && sampleData.cashier !== 'N/A') {
                            originalCashierValue = sampleData.cashier;
                        }
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                    sampleData = PrintTemplateEngine.getDefaultSampleData();
                    if (originalCashierValue === null && sampleData.cashier && sampleData.cashier !== 'N/A') {
                        originalCashierValue = sampleData.cashier;
                    }
                }
                
                // Filter tax data based on selected tax type and GSTIN visibility
                if (sampleData.tax) {
                    const taxData = { ...sampleData.tax };
                    
                    // If GSTIN is hidden, hide all tax fields
                    if (!showGSTIN) {
                        taxData.cgst = { rate: taxData.cgst?.rate || 0, amount: 0 };
                        taxData.sgst = { rate: taxData.sgst?.rate || 0, amount: 0 };
                        taxData.igst = { rate: taxData.igst?.rate || 0, amount: 0 };
                    } else {
                        // Apply tax type filtering only if GSTIN is visible
                        if (currentTaxType === 'cgst-sgst') {
                            // Show CGST/SGST, hide IGST
                            taxData.igst = { rate: taxData.igst?.rate || 0, amount: 0 };
                        } else {
                            // Show IGST, calculate amount from CGST + SGST if IGST amount is 0
                            const cgstAmount = taxData.cgst?.amount || 0;
                            const sgstAmount = taxData.sgst?.amount || 0;
                            const igstAmount = taxData.igst?.amount || 0;
                            
                            // If IGST amount is 0, calculate it from CGST + SGST
                            const calculatedIgstAmount = igstAmount > 0 ? igstAmount : (cgstAmount + sgstAmount);
                            const igstRate = taxData.igst?.rate || ((taxData.cgst?.rate || 0) + (taxData.sgst?.rate || 0));
                            
                            taxData.igst = { rate: igstRate, amount: calculatedIgstAmount };
                            taxData.cgst = { rate: taxData.cgst?.rate || 0, amount: 0 };
                            taxData.sgst = { rate: taxData.sgst?.rate || 0, amount: 0 };
                        }
                    }
                    sampleData.tax = taxData;
                }
                
                // Hide/show cashier field based on toggle
                if (!showCashier) {
                    // Store original value if not already stored
                    if (originalCashierValue === null && sampleData.cashier && sampleData.cashier !== 'N/A') {
                        originalCashierValue = sampleData.cashier;
                    }
                    sampleData.cashier = 'N/A';
                } else {
                    // Restore original value if available
                    if (originalCashierValue !== null) {
                        sampleData.cashier = originalCashierValue;
                    }
                }
                
                // Update payment type based on selected payment mode
                sampleData.payment_type = currentPaymentMode;
                
                // Update discount type based on toggle
                // When toggle is ON (percentage), discount value is treated as percentage rate
                // Label will show "Discount X%:" and value will show calculated amount "₹Y"
                if (sampleData.discount && sampleData.discount > 0) {
                    if (discountAsPercentage) {
                        // Set discount_type to percentage so label shows "Discount X%:"
                        // The rendering function will calculate and show the amount in rupees
                        sampleData.discount_type = 'percentage';
                    } else {
                        sampleData.discount_type = 'amount';
                    }
                }
                
                // Filter template elements based on logo visibility
                if (!showLogo && template.receipt_template && template.receipt_template.elements) {
                    // Create a copy of the template and filter out placeholder_block elements
                    template = {
                        ...template,
                        receipt_template: {
                            ...template.receipt_template,
                            elements: template.receipt_template.elements.filter(
                                element => element.type !== 'placeholder_block'
                            )
                        }
                    };
                }
                
                // Filter template elements based on GSTIN visibility
                if (!showGSTIN && template.receipt_template && template.receipt_template.elements) {
                    // Filter out GSTIN text elements (elements with value containing "GSTIN:")
                    template = {
                        ...template,
                        receipt_template: {
                            ...template.receipt_template,
                            elements: template.receipt_template.elements.filter(
                                element => {
                                    if (element.type === 'text' && element.value) {
                                        return !element.value.includes('GSTIN:');
                                    }
                                    return true;
                                }
                            )
                        }
                    };
                }
                
                // Add total_qty_items_row before total_amount_row for Bill and Transaction types (not Transaction V2)
                // Also filter out newline elements, QR code and "SCAN TO PAY" elements based on payment mode
                if (template.receipt_template && template.receipt_template.elements) {
                    const filteredElements = [];
                    const isTransactionV2 = currentTemplateType === 'transaction_v2';
                    
                    for (let i = 0; i < template.receipt_template.elements.length; i++) {
                        const element = template.receipt_template.elements[i];
                        const prevElement = i > 0 ? template.receipt_template.elements[i - 1] : null;
                        
                        // Insert total_qty_items_row before total_amount_row for Bill and Transaction (not V2)
                        // Only if showTotalQtyItems is true
                        if (element.type === 'total_amount_row' && !isTransactionV2 && showTotalQtyItems) {
                            filteredElements.push({ type: 'total_qty_items_row' });
                        }
                        
                        // Skip newline elements
                        if (element.type === 'newline') {
                            continue; // Skip newline element
                        }
                        
                        // Hide QR code if payment mode is Cash, UPI, or Card
                        if (element.type === 'qr_code') {
                            if (currentPaymentMode === 'Cash' || currentPaymentMode === 'UPI' || currentPaymentMode === 'Card') {
                                continue; // Skip QR code element
                            }
                        }
                        
                        // Skip "SCAN TO PAY" static_text if it comes after qr_code or newline after qr_code
                        // Also skip if QR code was hidden (payment mode is Cash/UPI/Card)
                        if (element.type === 'static_text' && element.value === 'SCAN TO PAY') {
                            if (currentPaymentMode === 'Cash' || currentPaymentMode === 'UPI' || currentPaymentMode === 'Card') {
                                continue; // Skip "SCAN TO PAY" when QR code is hidden
                            }
                            if (prevElement && (prevElement.type === 'qr_code' || 
                                (prevElement.type === 'newline' && i > 1 && template.receipt_template.elements[i - 2].type === 'qr_code'))) {
                                continue; // Skip this element
                            }
                        }
                        filteredElements.push(element);
                    }
                    
                    template = {
                        ...template,
                        receipt_template: {
                            ...template.receipt_template,
                            elements: filteredElements
                        }
                    };
                }
                
                // Validate template
                const validation = PrintTemplateEngine.validateTemplate(template);
                if (!validation.valid) {
                    throw new Error('Template validation failed: ' + validation.errors.join(', '));
                }
                
                // Render preview
                let html = PrintTemplateEngine.renderPreview(template, sampleData);
                
                // For Bill template, apply formatting based on toggles
                if (currentTemplateType === 'bill') {
                    const receiptElement = document.createElement('div');
                    receiptElement.innerHTML = html;
                    
                    // Apply decimal formatting if needed
                    if (!showDecimals) {
                        // Update item price and amount fields
                        const priceElements = receiptElement.querySelectorAll('.item-price');
                        const amountElements = receiptElement.querySelectorAll('.item-amount');
                        
                        priceElements.forEach(el => {
                            const text = el.textContent.trim();
                            const num = parseFloat(text.replace(/,/g, ''));
                            if (!isNaN(num)) {
                                el.textContent = Math.round(num).toLocaleString('en-IN');
                            }
                        });
                        
                        amountElements.forEach(el => {
                            const text = el.textContent.trim();
                            const num = parseFloat(text.replace(/,/g, ''));
                            if (!isNaN(num)) {
                                el.textContent = Math.round(num).toLocaleString('en-IN');
                            }
                        });
                        
                        // Update total row currency values
                        const totalRows = receiptElement.querySelectorAll('.total-row span:last-child');
                        totalRows.forEach(el => {
                            const text = el.textContent.trim();
                            // Match currency format ₹X,XXX.XX
                            const currencyMatch = text.match(/₹([\d,]+)\.(\d{2})/);
                            if (currencyMatch) {
                                const num = parseFloat(currencyMatch[1].replace(/,/g, ''));
                                if (!isNaN(num)) {
                                    el.textContent = '₹' + Math.round(num).toLocaleString('en-IN');
                                }
                            }
                        });
                    }
                    
                    // Hide serial number column if needed
                    if (!showSerialNo) {
                        // Hide serial number header
                        const snoHeaders = receiptElement.querySelectorAll('.item-header-row .item-sno, .item-header .item-sno');
                        snoHeaders.forEach(el => {
                            el.style.display = 'none';
                        });
                        
                        // Hide serial number cells in item rows
                        const snoCells = receiptElement.querySelectorAll('.bill-item-row .item-sno');
                        snoCells.forEach(el => {
                            el.style.display = 'none';
                        });
                        
                        // Adjust grid template columns to remove serial number column
                        const itemTables = receiptElement.querySelectorAll('.item-table');
                        itemTables.forEach(table => {
                            table.style.gridTemplateColumns = '2fr 1fr 1.4fr 1fr'; // Remove 0.3fr for serial number
                        });
                    }
                    
                    html = receiptElement.innerHTML;
                }
                
                // Wrap in format container
                html = `<div class="preview-receipt" data-format="${currentFormat}">${html}</div>`;
                
                previewContent.innerHTML = html;
                
                // Fade in new content
                previewContent.classList.remove('fade-out');
                previewContent.classList.add('fade-in');
                
                // Mark that initial load is complete
                if (isInitialLoad) {
                    isInitialLoad = false;
                }
                
                // Log warnings if any
                if (validation.warnings.length > 0) {
                    console.warn('Template warnings:', validation.warnings);
                }
                
            } catch (error) {
                previewContent.innerHTML = `<div class="error">
                    <strong>Error loading preview:</strong><br>
                    ${error.message}<br><br>
                    Make sure the template file is in <code>templates/</code> and <code>variables-example.json</code> is in <code>data/</code> directory.
                </div>`;
                
                // Fade in error message
                previewContent.classList.remove('fade-out');
                previewContent.classList.add('fade-in');
                
                // Mark that initial load is complete even on error
                if (isInitialLoad) {
                    isInitialLoad = false;
                }
                
                console.error('Preview error:', error);
            }
        }
        
        // Load preview on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadPreview();
            
            // Add event listener for template type changes
            document.getElementById('template-type-select').addEventListener('change', (e) => {
                currentTemplateType = e.target.value;
                // Show/hide controls based on template type
                const decimalsControl = document.getElementById('decimals-control');
                const serialNoControl = document.getElementById('serial-no-control');
                const totalQtyItemsControl = document.getElementById('total-qty-items-control');
                if (currentTemplateType === 'bill') {
                    decimalsControl.style.display = 'flex';
                    serialNoControl.style.display = 'flex';
                    totalQtyItemsControl.style.display = 'flex';
                } else if (currentTemplateType === 'transaction') {
                    decimalsControl.style.display = 'none';
                    serialNoControl.style.display = 'none';
                    totalQtyItemsControl.style.display = 'flex';
                } else {
                    decimalsControl.style.display = 'none';
                    serialNoControl.style.display = 'none';
                    totalQtyItemsControl.style.display = 'none';
                }
                loadPreview();
            });
            
            // Initialize control visibility
            const decimalsControl = document.getElementById('decimals-control');
            const serialNoControl = document.getElementById('serial-no-control');
            const totalQtyItemsControl = document.getElementById('total-qty-items-control');
            if (currentTemplateType === 'bill') {
                decimalsControl.style.display = 'flex';
                serialNoControl.style.display = 'flex';
                totalQtyItemsControl.style.display = 'flex';
            } else if (currentTemplateType === 'transaction') {
                decimalsControl.style.display = 'none';
                serialNoControl.style.display = 'none';
                totalQtyItemsControl.style.display = 'flex';
            } else {
                decimalsControl.style.display = 'none';
                serialNoControl.style.display = 'none';
                totalQtyItemsControl.style.display = 'none';
            }
            
            // Initialize payment mode selector
            const paymentModeSelect = document.getElementById('payment-mode-select');
            if (paymentModeSelect) {
                paymentModeSelect.value = currentPaymentMode;
            }
            
            // Initialize discount type button states
            document.getElementById('discount-percentage').classList.toggle('active', discountAsPercentage);
            document.getElementById('discount-currency').classList.toggle('active', !discountAsPercentage);
        });

        /**
         * Export receipt preview to PNG
         */
        async function exportToPNG() {
            const receiptElement = document.querySelector('.preview-receipt');
            if (!receiptElement) {
                alert('No receipt preview available. Please load a template first.');
                return;
            }

            try {
                // Check if html2canvas is loaded
                if (typeof html2canvas === 'undefined') {
                    alert('Export library not loaded. Please check your internet connection.');
                    return;
                }

                // Show loading indicator (don't replace content)
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'export-loading';
                loadingIndicator.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 10000;';
                loadingIndicator.textContent = 'Generating PNG...';
                document.body.appendChild(loadingIndicator);

                // Capture the receipt
                const canvas = await html2canvas(receiptElement, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher quality
                    logging: false,
                    useCORS: true,
                    allowTaint: false
                });

                // Remove loading indicator
                document.body.removeChild(loadingIndicator);

                // Convert to blob and download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `receipt-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
            } catch (error) {
                console.error('Error exporting to PNG:', error);
                alert('Error exporting to PNG: ' + error.message);
                // Remove loading indicator if it exists
                const loadingIndicator = document.getElementById('export-loading');
                if (loadingIndicator) {
                    document.body.removeChild(loadingIndicator);
                }
            }
        }

        /**
         * Export receipt preview to PDF
         */
        async function exportToPDF() {
            const receiptElement = document.querySelector('.preview-receipt');
            if (!receiptElement) {
                alert('No receipt preview available. Please load a template first.');
                return;
            }

            try {
                // Check if libraries are loaded
                if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                    alert('Export libraries not loaded. Please check your internet connection.');
                    return;
                }

                const { jsPDF } = window.jspdf;

                // Show loading indicator (don't replace content)
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'export-loading';
                loadingIndicator.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 10000;';
                loadingIndicator.textContent = 'Generating PDF...';
                document.body.appendChild(loadingIndicator);

                // Capture the receipt as image
                const canvas = await html2canvas(receiptElement, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: false
                });

                // Remove loading indicator
                document.body.removeChild(loadingIndicator);

                // Get dimensions
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const imgData = canvas.toDataURL('image/png');

                // Determine format from receipt element
                const format = receiptElement.getAttribute('data-format') || '3inch';
                const pdfWidth = format === '2inch' ? 48 : 80; // Receipt width in mm
                const pdfHeight = (imgHeight * pdfWidth) / imgWidth;

                // Create PDF
                const pdf = new jsPDF({
                    orientation: pdfHeight > pdfWidth ? 'portrait' : 'landscape',
                    unit: 'mm',
                    format: [pdfWidth, pdfHeight]
                });

                // Add image to PDF
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                // Save PDF
                pdf.save(`receipt-${Date.now()}.pdf`);
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                alert('Error exporting to PDF: ' + error.message);
                // Remove loading indicator if it exists
                const loadingIndicator = document.getElementById('export-loading');
                if (loadingIndicator) {
                    document.body.removeChild(loadingIndicator);
                }
            }
        }
    </script>
</body>
</html>

